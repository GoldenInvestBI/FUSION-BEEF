name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      
      - name: Install pnpm
        run: npm install -g pnpm
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build application
        run: pnpm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          OAUTH_SERVER_URL: ${{ secrets.OAUTH_SERVER_URL }}
          OWNER_NAME: ${{ secrets.OWNER_NAME }}
          OWNER_OPEN_ID: ${{ secrets.OWNER_OPEN_ID }}
          VITE_APP_ID: ${{ secrets.VITE_APP_ID }}
          VITE_APP_TITLE: ${{ secrets.VITE_APP_TITLE }}
          VITE_APP_LOGO: ${{ secrets.VITE_APP_LOGO }}
      
      - name: Create deployment package
        run: |
          tar -czf fusion-beef-deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.manus' \
            --exclude='*.log' \
            --exclude='.deploy_token' \
            --exclude='.ssh_keys' \
            dist/ server/ drizzle/ scripts/ package.json pnpm-lock.yaml
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 159.65.167.133 >> ~/.ssh/known_hosts
      
      - name: Deploy to Digital Ocean
        run: |
          # Upload deployment package
          scp -i ~/.ssh/deploy_key fusion-beef-deploy.tar.gz root@159.65.167.133:/tmp/
          
          # Execute deployment commands on server
          ssh -i ~/.ssh/deploy_key root@159.65.167.133 << 'ENDSSH'
            set -e
            
            # Create app directory
            mkdir -p /var/www/fusion-beef
            
            # Backup current version
            if [ -d "/var/www/fusion-beef/dist" ]; then
              echo "Creating backup..."
              mkdir -p /var/backups
              tar -czf /var/backups/fusion-beef-$(date +%Y%m%d-%H%M%S).tar.gz -C /var/www/fusion-beef . 2>/dev/null || true
            fi
            
            # Extract new version
            echo "Extracting new version..."
            tar -xzf /tmp/fusion-beef-deploy.tar.gz -C /var/www/fusion-beef
            
            # Install production dependencies
            cd /var/www/fusion-beef
            
            # Install pnpm if not present
            if ! command -v pnpm &> /dev/null; then
              npm install -g pnpm
            fi
            
            pnpm install --prod
            
            # Restart application with PM2
            if command -v pm2 &> /dev/null; then
              if pm2 list | grep -q "fusion-beef"; then
                echo "Restarting application..."
                pm2 restart fusion-beef
              else
                echo "Starting application..."
                pm2 start server/index.js --name fusion-beef
                pm2 save
              fi
              
              # Setup PM2 startup
              pm2 startup systemd -u root --hp /root || true
            else
              echo "PM2 not installed. Please install PM2 manually."
            fi
            
            echo "Deployment completed successfully!"
          ENDSSH
      
      - name: Verify deployment
        run: |
          echo "Waiting for application to start..."
          sleep 10
          
          # Check if application is responding
          curl -f https://www.fusionbeef.com.br || echo "Warning: Application may not be responding yet"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f fusion-beef-deploy.tar.gz
